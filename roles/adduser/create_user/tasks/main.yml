---
- fail: "username was not defined."
  when: username is not defined

- debug: msg="Adding user {{ username }}"

- set_fact: userpassword_dir="/{{ inventory_dir }}/credentials/{{ inventory_hostname }}/{{ username }}"

- name: mkdir credentials hostname username
  file: path="{{ userpassword_dir }}"
        state=directory
        mode=0700
  delegate_to: localhost

- name: create user
  sudo: yes
  user: name="{{ username }}"
        comment="{{ username }}"
        state=present
        shell={{ default_shell }}
        generate_ssh_key="yes"
        password={{ item }}
        update_password=always
  with_password: "{{ userpassword_dir }}/userpassword encrypt=sha256_crypt"
