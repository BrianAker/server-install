---
- name: include vars
  include_vars: "{{ item }}"
  with_first_found:
    - files:
        - "{{ ansible_distribution }}.yml"
        - "{{ ansible_os_family }}.yml"
      paths: "{{ inventory_dir }}/roles/adduser/vars/"
 

- fail: "username was not defined."
  when: username is not defined

- debug: msg="Adding user {{ username }}"

- name: create user
  sudo: yes
  user: name="{{ username }}"
        comment="{{ username }}"
        state=present
        shell={{ default_shell }}
        generate_ssh_key="yes"
  when: "ansible_distribution != 'MacOSX'"

- file: state=directory
        path="~{{ username }}/.bazaar/plugins"
  sudo: yes
  sudo_user: "{{ username }}"

- name: setup authorized_key
  sudo: yes
  sudo_user: "{{ username }}"
  ignore_errors: yes
  authorized_key: user="{{ username }}"
                  key="{{ lookup('file', '/' + inventory_dir + '/public_keys/' + username) }}"

- name: reset mode for authorized_keys
  sudo: yes
  sudo_user: "{{ username }}"
  file: path="~{{ username }}/.ssh/authorized_keys"
        mode=0600

- name: copy in specific
  sudo: yes
  sudo_user: "{{ username }}"
  template: src={{ item }}.j2 
            dest="~{{ username }}/.{{ item }}"
            mode=0600
            validate='bash -n %s'
  with_items:
    - customrc
    - pythonrc
    - perlrc
    - rubyrc

- name: copy in specific
  sudo: yes
  sudo_user: "{{ username }}"
  template: src={{ item }}.j2 
            dest="~{{ username }}/.{{ item }}"
            mode=0600
            validate='bash -n %s'
  with_items:
    - pkgngrc
  when: ansible_distribution in ('FreeBSD')

- name: copy in specific
  sudo: yes
  sudo_user: "{{ username }}"
  template: src={{ item }}.j2 
            dest="~{{ username }}/.{{ item }}"
            mode=0600
            validate='bash -n %s'
  with_items:
    - sbinrc
  when: ansible_distribution in ('Debian')

- name: copy in OSX specific
  sudo: yes
  sudo_user: "{{ username }}"
  template: src={{ item }}.j2 
            dest="~{{ username }}/.{{ item }}"
            mode=0600
            validate='bash -n %s'
  with_items:
    - brewrc
    - javarc
  when: ansible_distribution in ('MacOSX')

- name: copy in specific
  sudo: yes
  sudo_user: "{{ username }}"
  template: src={{ item }}.j2 
            dest="~{{ username }}/.{{ item }}"
            mode=0600
            validate='bash -n %s'
  with_items:
    - keychainrc
  when: keychain == True

- name: Reconfigure path for user to include customrc
  sudo: yes
  sudo_user: "{{ username }}"
  lineinfile: dest="~{{ username }}/.bash_profile"
              regexp="^. ~/.customrc"
              line=". ~/.customrc"
              mode=0700
              state=present
              create=yes

- name: install local pip packages for user
  sudo: yes
  sudo_user: "{{ username }}"
  pip:  name="{{ item }}"
        virtualenv_command="{{ virtualenv_bin }}"
        virtualenv="~/.python"
        state=present
  with_items: pip_packages
