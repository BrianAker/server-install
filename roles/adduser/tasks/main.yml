---
- file:
    state: directory
    path: "{{ user_homedir }}/.bazaar/plugins"
  sudo: yes
  sudo_user: "{{ User.name }}"

- set_fact: 
    profile_d: "{{ user_homedir }}/.profile.d"
  tags:
    - shellconf

- name: setup authorized_key
  sudo: yes
  ignore_errors: yes
  authorized_key:
    user: "{{ User.name }}"
    key: "{{ lookup('file', srcdir + '/public_keys/' + User.name) }}"

- name: reset mode for authorized_keys
  file: 
    path: "{{ user_homedir }}/.ssh/authorized_keys"
    mode: 0600
  sudo: yes
  sudo_user: "{{ User.name }}"
  when: "inventory_hostname != 'localhost'"

- file: 
    path: "{{ profile_d }}"
    mode: 0750
    state: directory
  sudo: yes
  sudo_user: "{{ User.name }}"
  tags:
    - shellconf

- name: copy in customrc
  template:
    src: "{{ item }}.j2"
    dest: "{{ user_homedir }}/.{{ item }}"
    mode: 0600
    validate: 'bash -n %s'
  with_items:
    - customrc
  sudo: yes
  sudo_user: "{{ User.name }}"
  tags:
    - shellconf

- name: copy in specific
  template: 
    src: "{{ item }}.j2"
    dest: "{{ profile_d }}/{{ item }}.sh"
    mode: 0600
    validate: 'bash -n %s'
  with_items:
    - pythonrc
    - perlrc
    - rubyrc
  sudo: yes
  sudo_user: "{{ User.name }}"
  tags:
    - shellconf

- name: copy in specific
  template: 
    src: "{{ item }}.j2"
    dest: "{{ profile_d }}/{{ item }}.sh"
    mode: 0600
    validate: 'bash -n %s'
  with_items:
    - pkgngrc
  when: ansible_distribution in ('FreeBSD')
  sudo: yes
  sudo_user: "{{ User.name }}"
  tags:
    - shellconf

- name: copy in specific
  template:
    src: "{{ item }}.j2"
    dest: "{{ profile_d }}/{{ item }}.sh"
    mode: 0600
    validate: 'bash -n %s'
  with_items:
    - sbinrc
  when: ansible_distribution in ('Debian')
  sudo: yes
  sudo_user: "{{ User.name }}"
  tags:
    - shellconf

- name: copy in OSX specific
  template:
    src: "{{ item }}.j2"
    dest: "{{ profile_d }}/{{ item }}.sh"
    mode: 0600
    validate: 'bash -n %s'
  with_items:
    - brewrc
    - localrc
    - javarc
    - configurerc
  when: ansible_distribution in ('MacOSX')
  sudo: yes
  sudo_user: "{{ User.name }}"
  tags:
    - shellconf

- name: copy in specific
  template:
    src: "{{ item }}.j2"
    dest: "{{ profile_d }}/{{ item }}.sh"
    mode: 0600
    validate: 'bash -n %s'
  with_items:
    - keychainrc
  when: keychain == True
  sudo: yes
  sudo_user: "{{ User.name }}"
  tags:
    - shellconf

- file:
    path: "{{ user_homedir }}/.bash_profile"
    state: touch
  sudo: yes
  sudo_user: "{{ User.name }}"
  tags:
    - shellconf

- name: Reconfigure path for user to include customrc
  lineinfile: | 
              dest="{{ user_homedir }}/.bash_profile"
              regexp="customrc"
              line="if [ -f '.customrc' ]; then . '.customrc'; fi"
              mode=0700
              state=present
              backrefs=yes
              create=yes
  sudo: yes
  sudo_user: "{{ User.name }}"
  tags:
    - shellconf

- include: sudo.yaml
  when: is_admin is defined && is_admin

- name: ssh-import-id-lp
  command: "ssh-import-id-lp {{ ssh_import_id_lp }}"
  sudo: yes
  sudo_user: "{{ User.name }}"
  when: ssh_import_id_lp is defined

- name: ssh-import-id-gh
  command: "ssh-import-id-gh {{ ssh_import_id_gh }}"
  sudo: yes
  sudo_user: "{{ User.name }}"
  when: ssh_import_id_gh is defined
