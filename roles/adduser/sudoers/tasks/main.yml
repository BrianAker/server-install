---
- set_fact: sudoer_user_file='{{ sudoers_d }}/{{ User.name }}'

- name: write sudoers file
  sudo: yes
  copy:     src=sudoer
            dest="{{ sudoer_user_file }}"
            owner=root 
            mode=0440
            group="{{ root_group }}"
            force=no

# Fit it so deploy doesn't require tty
- name: add include directory for sudoers
  sudo: yes
  lineinfile: state=present
              dest="{{ sudoer_user_file }}"
              regexp='^{{ item.key }}'
              line='{{ item.key }} {{ item.value }}'
              validate='visudo -cf %s'
  with_items:
    - { key: "{{ User.name }}", value: 'ALL=(ALL) NOPASSWD:ALL'}
    - { key: "Defaults:{{ User.name }}", value: '!requiretty'}
