--- # vim:ft=yaml
# Load a variable file based on the OS type, or a default if not found.
- include_vars: "{{ item }}"
  with_first_found:
    - "{{ ansible_distribution }}.yml"
    - "default.yml"

- include: validate.yaml

- group:  
    name: wheel
    state: present
  when: "ansible_distribution != 'MacOSX'"
  sudo: yes

- name: mkdir sudoers.d
  file: 
    path: "{{ sudoers_d }}"
    state: directory
    owner: root
    group: "{{ root_group }}"
    mode: 0750
  sudo: yes

- file: 
    dest: "{{ sudoers_conf }}"
    state: touch
    owner: root
    group: "{{ root_group }}"
    mode: 0440
  sudo: yes

- name: configure sudoers
  lineinfile: 
    dest: "{{ sudoers_conf }}"
    state: present
    regexp: '^{{ item.key }}'
    line: '{{ item.value }}'
    validate: 'visudo -cf %s'
  with_items:
    - key: 'root'
      value: 'root ALL=(ALL) ALL'
    - key: '#includedir'
      value: "#includedir {{ sudoers_d }}"
    - key: '%wheel'
      value: '%wheel ALL=(ALL) NOPASSWD: ALL'
    - key: 'Defaults env_keep.*SH_AUTH_SOCK'
      value: 'Defaults env_keep += "SSH_AUTH_SOCK"'
  tags: config
  sudo: yes

- file: 
    dest: /etc/security/authorized_keys
    state: touch
    owner: root
    group: "{{ root_group }}"
    mode: 0600
  sudo: yes
