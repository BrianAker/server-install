---

- include_vars: "{{ ansible_distribution }}.yml"

- name: Poke a hole through the firewall for ssh
  sudo: yes
  firewalld:  service=ssh
              permanent=true
              state=enabled
  when: ansible_distribution == 'Fedora'

- name: Reconfigure SSH PasswordAuthentication no
  sudo: yes
  lineinfile: dest={{ sshd_config_file }}
              regexp="^PasswordAuthentication"
              line="PasswordAuthentication no"
              validate='/usr/sbin/sshd -T -f %s'
              state=present
  notify: set sshd for restart

- name: Reconfigure SSH PermitRootLogin no
  sudo: yes
  lineinfile: dest={{ sshd_config_file }}
              regexp="^PermitRootLogin"
              line="PermitRootLogin no"
              validate='/usr/sbin/sshd -T -f %s'
              state=present
  notify: set sshd for restart

- name: Reconfigure SSH AllowAgentForwarding yes
  sudo: yes
  lineinfile: dest={{ sshd_config_file }}
              regexp="^AllowAgentForwarding"
              line="AllowAgentForwarding yes"
              validate='/usr/sbin/sshd -T -f %s'
              state=present
  notify: set sshd for restart

- name: Reconfigure SSH PermitEmptyPasswords no
  sudo: yes
  lineinfile: dest={{ sshd_config_file }}
              regexp="^PermitEmptyPasswords"
              line="PermitEmptyPasswords no"
              validate='/usr/sbin/sshd -T -f %s'
              state=present
  notify: set sshd for restart

- name: Reconfigure SSH to use .ssh/authorized_keys/
  sudo: yes
  lineinfile: dest={{ sshd_config_file }}
              regexp="^AuthorizedKeysFile"
              line="AuthorizedKeysFile .ssh/authorized_keys"
              state=present
              validate='/usr/sbin/sshd -T -f %s'
  notify: set sshd for restart

- name: enable sshd
  sudo: yes
  service:  name={{ service_sshd }}
            enabled=yes
  when: ansible_distribution != 'MacOSX'

- name: enable sshd
  sudo: yes
  service:  name={{ service_sshd }}
            state=restarted
  when: sshd_should_restart and ansible_distribution != 'MacOSX'
  notify: restart sshd
