---
- fail: "username was not defined."
  when: username is not defined

- set_fact: sudoer_user_file='{{ sudoers_d }}/{{ username }}'

- debug: msg="Adding user {{ username }} with file {{ sudoer_user_file }}"

- name: write sudoers file
  sudo: yes
  template: src=sudoer.j2
            dest={{ sudoer_user_file }}
            owner=root 
            mode=0440
            group="{{ root_group }}"
#           validate='visudo -cf %s'

# Fit it so deploy doesn't require tty
- name: add include directory for sudoers
  sudo: yes
  lineinfile: state=present
              dest={{ sudoer_user_file }}
              regexp='^{{ item.key }}'
              line='{{ item.key }} {{ item.value }}'
              validate='visudo -cf %s'
  with_items:
    - { key: "{{ username }}", value: 'ALL=(ALL) NOPASSWD:ALL'}
    - { key: "Defaults:{{ username }}", value: '!requiretty'}

- name: add user to wheel
  sudo: yes
  user: name="{{ username }}" state=present groups=wheel append=yes
  when: "ansible_distribution == 'FreeBSD'"
