---
- name: create jenkins user
  action: user name=jenkins state=present

- name: Add keys for CI user
  ignore_errors: yes
  sudo: yes
  raw: sudo -u jenkins -i ssh-import-id d-ci

- name: chown jenkins/.ssh/authorized_keys
  file: path=~jenkins/.ssh/authorized_keys owner=jenkins group=jenkins mode=0400

- name: copy in pythonrc
  copy: src=templates/pythonrc 
        dest="/home/jenkins/.pythonrc"
        owner="jenkins"
        mode=0600

- name: Install ssh-import-id
  pip: name=$item state=latest
        virtualenv=~/.python
  with_items:
    - ssh-import-id
    - Sphinx
    - sphinxcontrib-googleanalytics

- name: Reconfigure path for jenkins user to include pythonrc
  lineinfile: dest=/home/jenkins/.profile
              regexp="^. ~/.pythonrc"
              line=". ~/.pythonrc"
              state=present
              create=yes

- name: Reconfigure SSH to not allow deploy_user login
  lineinfile: dest=/etc/ssh/sshd_config 
              regexp="^AllowUsers jenkins"
              line="AllowUsers jenkins"
