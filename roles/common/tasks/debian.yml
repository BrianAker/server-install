---

- name: apt update dist
  sudo: yes
  apt:  update_cache=yes cache_valid_time=3600 upgrade=dist
  when: ansible_pkg_mgr == 'apt'

- name: apt python-setuptools
  sudo: yes
  apt:  update_cache=yes cache_valid_time=3600 pkg={{ item }} state=present
  with_items:
    - python-setuptools
  when: ansible_distribution == 'Ubuntu' and ansible_distribution_version == 'precise'

- name: apt base software
  sudo: yes
  apt:  update_cache=yes cache_valid_time=3600 pkg={{ item }} state=present
  with_items:
    - cron-apt
    - curl
    - denyhosts
    - fail2ban
    - fakeroot
    - git
    - gnupg-agent
    - ifmetric
    - keychain
    - lsb-release
    - make
    - perl
    - pkg-config
    - python
    - python-dev
    - python-software-properties
    - ruby
    - sudo
    - tar
    - unattended-upgrades
    - update-manager-core
    - wget

- name: apt install python-software-properties
  sudo: yes
  apt:  update_cache=yes cache_valid_time=3600 pkg={{ item }} state=present
  ignore_errors: yes
  with_items:
    - python-software-properties
    - software-properties-common
  when: ansible_distribution == 'Debian'

- name: Message of the day explaining server is under Ansible control.
  sudo: yes
  copy: src=etc-update-motd-d-95-ansible 
        dest=/etc/update-motd.d/95-ansible 
        mode=755
  when: ansible_distribution == 'Ubuntu'

- name: remove ubuntu ssh-import-id
  sudo: yes
  apt:  pkg=ssh-import-id state=absent
  when: ansible_distribution == 'Ubuntu'

- name: Adjust APT update intervals
  sudo: yes
  copy: src=apt_periodic
        dest=/etc/apt/apt.conf.d/10periodic

- name: Make sure unattended-security-upgrades work
  sudo: yes
  lineinfile: dest=/etc/apt/apt.conf.d/50unattended-upgrades
              regexp="-security"
              line='"${distro_id}:${distro_codename}-security";'

- name: Make sure unattended-updates work
  sudo: yes
  lineinfile: dest=/etc/apt/apt.conf.d/50unattended-upgrades
              regexp="-updates"
              line='"${distro_id}:${distro_codename}-updates";'
