---
# Upgrade the fleet
- hosts: all
  name: Maintenance
  tasks:
    - name: Create groups by distribution
      group_by: key={{ansible_distribution}}

    - name: Create a distribution based OS family
      group_by: key={{ansible_os_family}}

  roles:
    - { role: upgrade, expire_cache=True }

  tasks:
  - name: upgrade user packages
    sudo: yes
    sudo_user: "{{ item }}"
    command: "pip freeze --local | grep -v '^\-e' | cut -d = -f 1  | xargs pip install -U"
    ignore_errors: yes
    with_items:
      - deploy
      - jenkins

- hosts: Debian
  sudo: yes
  tasks:
    - command: apt-file update
      tags: upgrade
    - command: reboot
