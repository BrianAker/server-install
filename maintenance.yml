---
# Upgrade the fleet
- name: Maintenance
  hosts: all

  vars_files:
     - "vars/{{ ansible_os_family }}"
     - "vars/{{ ansible_distribution }}"
     - "vars/Defaults"

  tasks:
    - name: Create groups by distribution
      group_by: key={{ansible_distribution}}

    - name: Create a distribution based OS family
      group_by: key={{ansible_os_family}}

  roles:
    - { role: upgrade, expire_cache=True }

  tasks:
  - command: which pip
    sudo: yes
    sudo_user: deploy
    register: which_pip_result

  - debug: var=which_pip_result

  - command: which pip
    sudo: yes
    sudo_user: root
    register: which_pip_result

  - debug: var=which_pip_result

  - name: upgrade user packages
    sudo: yes
    sudo_user: "{{ item }}"
    raw: pip freeze | awk -F'==' '{ print $1 }' | xargs pip install --upgrade
    ignore_errors: yes
    with_items:
      - deploy
      - jenkins

- hosts: Debian
  sudo: yes
  tasks:
    - command: apt-file update
      tags: upgrade
    - command: reboot
