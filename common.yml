---
- name: Common Play
  hosts: all

  vars_files:
     - "vars/{{ ansible_os_family }}"
     - "vars/{{ ansible_distribution }}"
     - "vars/Defaults"

  tasks:
  - name: create ansible_distribution group
    group_by: key={{ ansible_distribution }}

  - name: create ansible_distribution group
    group_by: key={{ ansible_os_family }}

  - name: create ansible_pkg_mgr group
    group_by: key={{ ansible_pkg_mgr }}

  roles:
    - role: common
    - role: sudoers
    - role: python
    - role: ntp
    - role: sshd
    - role: deploy
    - role: unattended-upgrades

- hosts: Debian 
  roles:
  - role: jnv.unattended-upgrades
    unattended_allowed_origins: [security, updates]
    sudo: yes

- hosts: RedHat
  roles:
  - role: yum-cron

- hosts: Fedora
  tasks:
  - name: install packages with yum
    yum:  name={{ item }}
          state=present
    with_items: common_packages[ansible_distribution]
    sudo: yes
    tags: package_install
  - name: install open-vm-tools 
    sudo: yes
    yum:  name=open-vm-tools
          state=present
    when: ansible_virtualization_role == 'Guest'
    tags: package_install
  - service: >
              name=tuned
              state=started
              enabled=yes
    sudo: yes

- hosts: Ubuntu
  tasks:
  - apt:  update_cache=yes
          cache_valid_time=3600
          name={{ item }}
          state=present
    with_items:
    - powertop
    - pm-utils
    sudo: yes
    tags: package_install

  - command: pm-powersave true
    sudo: yes
