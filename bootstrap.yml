#!/usr/bin/env -v -S ansible-playbook --flush-cache
# vim: set filetype=ansible:
---
- hosts: disabled
  gather_facts: no
  connection: local

  tasks:
    - name: remove old host key
      known_hosts:
          name: "{{ inventory_hostname }}"
          state: absent

    - name: Check for hostkey
      command: ssh-keyscan -H -T 10 {{ inventory_hostname }}
      with_items: inventory_hostname
      register: ssh_known_host_results

    - name: Results of keyscan
      debug:
          var: ssh_known_host_results.results

    - name: remove old host key
      known_hosts:
          name: "{{ inventory_hostname }}"
          key: "{{ ssh_known_host_results.results }}"
          state: present

- hosts: all:!unmanaged
  gather_facts: no
  tasks:
  - name: Gather host type
    setup:
      gather_subset: '!all'
  - name: create ansible_distribution group
    group_by: key={{ ansible_distribution }}

- hosts: all:!unmanaged
  remote_user: "{{ deployment_user }}"

  roles:
    - role: bootstrap
- include: playbooks/upgrade.yml

- hosts: all:!unmanaged
  remote_user: "{{ deployment_user }}"
  roles:
    - { role: f500.dumpall, dumpall_flat_mode: yes, dumpall_host_destination: examine/ }
