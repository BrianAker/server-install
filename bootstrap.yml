---
# Rulebook used for bootstrapping a system.
#- name: Bootstrap
#  hosts: FreeBSD
#  gather_facts: no
#  remote_user: root
#
#  roles:
#    - bootstrap/FreeBSD
#

- hosts: disabled
  gather_facts: no
  connection: local

  tasks:
    - name: remove old host key
      known_hosts: 
          name: {{ inventory_hostname }}
          state: absent

    - name: Check for hostkey
      command: ssh-keyscan -H -T 10 {{ inventory_hostname }}
      with_items: inventory_hostname
      register: ssh_known_host_results

    - name: Results of keyscan
    - debug: 
          var: ssh_known_host_results.results

    - name: remove old host key
      known_hosts: 
          name: {{ inventory_hostname }}
          key: {{ ssh_known_host_results.results }}
          state: present

- hosts: all:!unmanaged
  remote_user: "{{ bootstrap_user }}"
  roles:
    - { role: f500.dumpall, dumpall_host_destination: examine/ }
    - group_by 

- hosts: Fedora
  remote_user: "{{ bootstrap_user }}"
  tasks:
    - name: Install yum compatibility for Fedora
      dnf: 
          name: "{{ item }}"
          state: present
      with_items:
      - dnf-yum 
      - yum-utils
      sudo: true

- hosts: FreeBSD
  remote_user: "{{ bootstrap_user }}"
  roles:
    - role: bootstrap/FreeBSD

- hosts: MacOSX
  remote_user: "{{ bootstrap_user }}"
  roles:
    - role: bootstrap/MacOSX

- hosts: all:!unmanaged
  remote_user: "{{ bootstrap_user }}"

  roles:
    - role: bootstrap
    - role: sudoers
    - role: python
    - role: ntp
    - role: sshd
    - role: deploy
    - role: unattended-upgrades

- include: playbooks/upgrade.yml
